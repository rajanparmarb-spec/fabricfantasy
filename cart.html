<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FabricFantasy | Your Cart</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- Header -->
<header>
    <div class="logo">FabricFantasy</div>
    <div class="menu-icon" onclick="toggleMenu()">☰</div>
    <nav id="nav-menu">
        <a href="index.html">Home</a>
        <a href="categories.html">Categories</a>
        <a href="index.html#shop">Shop</a>
        <a href="index.html#reviews">Reviews</a>
        <a href="index.html#newsletter">Subscribe</a>
        <a href="cart.html" class="cart">
            <i class="fa fa-shopping-cart fa-lg"></i>
            <span id="cart-count">0</span>
        </a>
    </nav>
</header>

<!-- Cart Page -->
<section class="cart-page">
    <div class="cart-layout">

        <div class="cart-left">
            <h2>Your Shopping Cart</h2>
            <div class="product-grid" id="cart-items"></div>
        </div>

    <!-- RIGHT: CUSTOMER + SUMMARY -->
    <div class="cart-right">
        <div class="cart-summary-box">
            <h3>Customer Details</h3>
            <div class="customer-form">
                <div class="form-group with-icon">
                    <label for="customer-name">Full Name *</label>
                    <input type="text" id="customer-name" placeholder="Enter your full name" required>
                    <i class="fa fa-user input-icon"></i>
                </div>
                
                <div class="form-group with-icon">
                    <label for="customer-email">Email Address *</label>
                    <input type="email" id="customer-email" placeholder="your@email.com" required>
                    <i class="fa fa-envelope input-icon"></i>
                </div>
                
                <div class="form-group with-icon">
                    <label for="customer-phone">Phone Number *</label>
                    <input type="tel" id="customer-phone" placeholder="+91 XXXXX XXXXX" required>
                    <i class="fa fa-phone input-icon"></i>
                </div>
                
                <div class="form-group">
                    <label for="customer-address">Delivery Address *</label>
                    <textarea id="customer-address" rows="3" placeholder="Enter your complete delivery address with pincode" required></textarea>
                </div>
            </div>

            <h3>Order Summary</h3>
            <div class="summary-line">
                <span>Total</span>
                <strong id="cart-total">₹0</strong>
            </div>

            <button class="checkout-btn" onclick="payNow()">Proceed to Checkout</button>

            <p class="secure-text"><i class="fa fa-lock"></i> Secure payment</p>
        </div>
	</div>
    </div>
</section>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="script.js"></script>
<script>
const APPSCRIPTURL = "https://script.google.com/macros/s/AKfycbzTuo2OlwBFyemhF_OxUK_5snLMgdwiGLnOz4Y0l7f9eVEJ3wL9oN4L1Ff0CdFO3uue/exec";

function paySuccessful(payload) {
	console.log(payload);
	// Send payment info to Apps Script for verification
	fetch(APPSCRIPTURL, {
		method: "POST",
		body: JSON.stringify(payload)
	})
		.then(res => res.json())
		.then(data => {
			if (data.status === "success") {
				cart = [];
				localStorage.setItem('cart', JSON.stringify(cart));
				renderCart();
				// Clear form
				document.getElementById('customer-name').value = '';
				document.getElementById('customer-email').value = '';
				document.getElementById('customer-phone').value = '';
				document.getElementById('customer-address').value = '';
			} else {
				console.log(data);
			}
		})
		.catch(err => console.error(err));
}

function validateForm() {
	const name = document.getElementById('customer-name').value.trim();
	const email = document.getElementById('customer-email').value.trim();
	const phone = document.getElementById('customer-phone').value.trim();
	const address = document.getElementById('customer-address').value.trim();
	
	if (!name) {
		alert('Please enter your name');
		return false;
	}
	
	if (!email) {
		alert('Please enter your email address');
		return false;
	}
	
	// Basic email validation
	const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
	if (!emailRegex.test(email)) {
		alert('Please enter a valid email address');
		return false;
	}
	
	if (!phone) {
		alert('Please enter your phone number');
		return false;
	}
	
	// Basic phone validation (at least 10 digits)
	const phoneRegex = /\d{10,}/;
	if (!phoneRegex.test(phone.replace(/\D/g, ''))) {
		alert('Please enter a valid phone number (at least 10 digits)');
		return false;
	}
	
	if (!address) {
		alert('Please enter your delivery address');
		return false;
	}
	
	return true;
}

function payNow() {
	const cart = JSON.parse(localStorage.getItem("cart")) || [];
	const total = cart.reduce((sum, item) => sum + item.price, 0);

	if(cart.length === 0){
		alert("Cart is empty!");
		return;
	}
	
	// Validate form before proceeding
	if (!validateForm()) {
		return;
	}
	
	// Get customer details
	const customerDetails = {
		name: document.getElementById('customer-name').value.trim(),
		email: document.getElementById('customer-email').value.trim(),
		phone: document.getElementById('customer-phone').value.trim(),
		address: document.getElementById('customer-address').value.trim()
	};

	fetch(APPSCRIPTURL, {
		method: "POST",
		body: JSON.stringify(cart)
	})
		.then(res => res.json())
		.then(order => {
			const orderInfo = {
				amount: total * 100, // paise
				currency: "INR",
				name: "FabricFantasy",
				description: "Order Payment",
				order_id: order.id,
			};
			const options = {
				key: "rzp_test_Rwxwu3ZpDrI7S1",
				...orderInfo,
				prefill: {
					name: customerDetails.name,
					email: customerDetails.email,
					contact: customerDetails.phone
				},
				handler: function (response) {
					paySuccessful({
						...orderInfo, 
						payment_id: response.razorpay_payment_id,
						total: total,
						items: cart,
						customer: customerDetails,
						action: "create",
						order_id: response.razorpay_payment_id
					});
				}
			};

			const rzp = new Razorpay(options);
			rzp.open();
		});
}

// Retrieve cart from localStorage
let cart = JSON.parse(localStorage.getItem('cart')) || [];

// Render cart items
function renderCart() {
	const container = document.getElementById('cart-items');
	container.innerHTML = '';
	let total = 0;

	if(cart.length === 0){
		container.innerHTML = "<p style='text-align:center; color:#555;'>Your cart is empty.</p>";
		document.getElementById('cart-total').innerText = `₹0`;
		return;
	}

	cart.forEach((item, index) => {
		total += item.price;
		const div = document.createElement('div');
		div.classList.add('product');
		div.innerHTML = `
	    <img src="${item.image || 'https://via.placeholder.com/300'}" alt="${item.name}">
	    <h3>${item.name}</h3>
	    <p>₹${item.price}</p>
	    <button onclick="removeFromCart(${index})">Remove</button>
	`;
		container.appendChild(div);
	});

	document.getElementById('cart-total').innerText = `₹${total}`;
	document.getElementById('cart-count').innerText = cart.length;
}

// Remove item from cart
function removeFromCart(index) {
	cart.splice(index, 1);
	localStorage.setItem('cart', JSON.stringify(cart));
	renderCart();
}

// Initial render
renderCart();
</script>

</body>
</html>
